<!DOCTYPE html>
<html>
    <head>
        <title>Tareas</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="css/main.css">
        <link rel="stylesheet" href="css/datepicker.css">
        <script src="./js/vendor/jquery-1.9.1.js"></script>
        <script src="./js/vendor/bootstrap.min.js"></script>
        <script src="./js/vendor/underscore-min.js"></script>
        <script src="./js/vendor/backbone-min.js"></script>
        <script src="./js/vendor/backbone.paginator.min.js"></script>
        <script src="./js/vendor/bootstrap-datepicker.js"></script>
        <script data-main="src/main" src="./js/vendor/require.js"></script>
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
          <script src="../../assets/js/html5shiv.js"></script>
          <script src="../../assets/js/respond.min.js"></script>
        <![endif]-->
        <script>
            $(document).ready(function (){
                var idForo = localStorage.getItem("idForo");
                
                $.ajax({
                    url: "/ForosISIS.web/webresources/Tarea/getTareasForo",
                    type : "GET",
                    contentType: 'application/json',
                    data : { idForo : idForo },
                }).done(function(data) {
                    //localStorage.setItem("titulo", data.titulo);
                    $.each(data, function(index,value){
                       var theTr = $("<tr>");
                       $(theTr).append("<td>" + value.name + "</td>");
                       $(theTr).append("<td>" + value.descripcion + "</td>");
                       $(theTr).append("<td>" + value.estado + "</td>");
                       $(theTr).append("<td>" + value.responsable + "</td>");
                       $(theTr).append("<td><button class='btn btn-info notificar' value='" + value.responsable_tareaId + "'> Notificar Responsable</button></td>");
                       $("#body-principal").append($(theTr));
                    });
                    
                    $(".notificar").click(function (){
                        var idNotificante = this.value;
                        console.log("notificando");
                        $.ajax({
                             url: "/ForosISIS.web/webresources/Responsable/enviarCorreo",
                             type : "GET",
                             contentType: 'application/json',
                             data : { mensaje : 'como vas con tu tarea?', idResponsable : idNotificante },
                         }).done(function(data) {
                             //localStorage.setItem("titulo", data.titulo);
                             alert("Correo enviado!");
                         }, this).error(function(data) {
                             alert("No se ha podido establecer la conexion con el servidor.");
                         }, this);
                    });
                    
                }, this).error(function(data) {
                    alert("No se ha podido establecer la conexion con el servidor.");
                }, this);
                
                //------------------------GET ALL RESPONSABLES
                
                $.ajax({
                    url: "/ForosISIS.web/webresources/Responsable/getAllResponsables",
                    type : "GET",
                    contentType: 'application/json',
                }).done(function(data) {
                    var theSelect = $("#responsableSelect");
                    $.each(data.records, function(index,value){
                       var option = $("<option>").attr("value",value.id).text(value.name);
                       $(theSelect).append($(option));
                       
                });
                    
                //-----------------------GET FASES BY FORO
                
                $.ajax({
                    url: "/ForosISIS.web/webresources/Fase/getFasesByForo",
                    type : "GET",
                    contentType: 'application/json',
                    data : {idForo : localStorage.getItem("idForo")}
                }).done(function(data) {
                    var theSelect = $("#faseSelect");
                    $.each(data.records, function(index,value){
                       var option = $("<option>").attr("value",value.id).text(value.name);
                       $(theSelect).append($(option));
                       
                    });
                });
                
                //faseSelect
                    
                }, this).error(function(data) {
                    alert("No se ha podido establecer la conexion con el servidor.");
                }, this);
                
                
                //responsableSelect
                
                $("#crear").click(function (){
                   $("#myModal").modal();
                });
                
                $("#btnCrearTarea").click(function(){
                    var losDatos = $("#tareaForm").serializeArray();
                    var idFor = localStorage.getItem("idForo");
                    losDatos.push({idForo : idFor});
                    
                    
                    $.ajax({
                        url: "/ForosISIS.web/webresources/Tarea/crearTarea",
                        type : "GET",
                        contentType: 'application/json',
                        data : { idForo : idForo },
                    }).done(function(data) {
                        //localStorage.setItem("titulo", data.titulo);
                        alert("Se ha creado una nueva tarea");
                        window.top.location = "/ForosISIS.web/index2.html";
                    });
                });
            });
        </script>
    </head>
    <body>
        <div class="container">
            <button style="margin-bottom: 20px;" class="btn btn-info btn-lg btn-block" id="crear"><span class="glyphicon glyphicon-euro"></span> Crear Tarea</button>
            
            <div class="panel panel-primary">
                <div class="panel-heading">
                  <h3 class="panel-title">Tareas del Foro</h3>
                </div>
                <div class="panel-body">
                    <table class="table table-striped" style="margin-bottom: 0;">
                        <thead>
                            <tr>	
                                <th>Nombre</th>
                                <th>Descripcion</th>
                                <th>Estado</th>
                                <th>Responsable</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="body-principal">	    
                        </tbody>
                    </table>
                </div>
            </div>
            
            
            <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title" id="myModalLabel">Crear Tarea</h4>
          </div>
          <div class="modal-body">
            <div class="form-group">
                <form role="form" id="tareaForm" onsubmit="return false;">
                            <div class="form-group">
                            <label for="name">Name</label>
                    <input type="text" class="form-control" id="name" name="name" placeholder="Enter value" value="">	
                            </div>
                            <div class="form-group">
                            <label for="responsable">Responsable</label>
                    <input type="text" class="form-control" id="responsable" name="responsable" placeholder="Enter value" value="">	
                            </div>
                            <div class="form-group">
                                    <label for="fechaInicio">Fecha Inicio</label>
                            <input type="text" data-converter="date" data-date-format="dd/mm/yyyy" class="form-control" id="fechaInicio" name="fechaInicio" placeholder="Enter value">
                            <script>
                            $('#fechaInicio').datepicker({autoclose:true});
                            //$('#fechaInicio').datepicker('setDate',App.Utils.Converter.date.toDate(""));
                            </script>
                            </div>
                            <div class="form-group">
                                    <label for="fechaFin">Fecha Fin</label>
                            <input type="text" data-converter="date" data-date-format="dd/mm/yyyy" class="form-control" id="fechaFin" name="fechaFin" placeholder="Enter value">
                            <script>
                            $('#fechaFin').datepicker({autoclose:true});
                            //$('#fechaFin').datepicker('setDate',App.Utils.Converter.date.toDate(""));
                            </script>
                            </div>
                            <div class="form-group">
                            <label for="descripcion">Descripcion</label>
                    <input type="text" class="form-control" id="descripcion" name="descripcion" placeholder="Enter value" value="">	
                            </div>
                            <div class="form-group">
                            <label for="estado">Estado</label>
                    <input type="text" class="form-control" id="estado" name="estado" placeholder="Enter value" value="">	
                            </div>
                            <div class="form-group">

                                    <label for="responsable_tareaidId">Responsable_tarea Id</label> 
                        <select class="form-control" id="responsableSelect" name="responsable_tareaId">
                                      <option value="">None</option>
                        </select>  
                            </div>
                            <div class="form-group">

                                    <label for="otro">Fase Id</label> 
                        <select class="form-control" id="faseSelect" name="otro">
                                      <option value="">None</option>
                        </select>  
                            </div>
                </form>
    </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="btnCrearTarea">Crear Tarea</button>
          </div>
        </div>
      </div>
    </div>
            
        </div>
        
        
    </body>
</html> 