<!DOCTYPE html>
<html>
    <head>
        <title>Tareas</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="css/main.css">
        <link rel="stylesheet" href="css/datepicker.css">
        <script src="./js/vendor/jquery-1.9.1.js"></script>
        <script src="./js/vendor/bootstrap.min.js"></script>
        <script src="./js/vendor/underscore-min.js"></script>
        <script src="./js/vendor/backbone-min.js"></script>
        <script src="./js/vendor/backbone.paginator.min.js"></script>
        <script src="./js/vendor/bootstrap-datepicker.js"></script>
        <script data-main="src/main" src="./js/vendor/require.js"></script>
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
          <script src="../../assets/js/html5shiv.js"></script>
          <script src="../../assets/js/respond.min.js"></script>
        <![endif]-->
        <script>
            $(document).ready(function (){
                var idForo = localStorage.getItem("idForo");
                
                function redirectFrame(url) {
                    $('#container').attr('src', url);
                    $('#container').css('height', ($(window).height() - $('#header').height() - 30) + 'px');
                }
                
                $.ajax({
                    url: "/ForosISIS.web/webresources/ForoMaster/tareasByForo",
                    type : "GET",
                    contentType: 'application/json',
                    data : { idForo : idForo },
                }).done(function(data) {
                    //localStorage.setItem("titulo", data.titulo);
                    $.each(data, function(index,value){
                       var theTr = $("<tr>");
                       $(theTr).append("<td>" + value.name + "</td>");
                       $(theTr).append("<td>" + value.descripcion + "</td>");
                       $(theTr).append("<td>" + "<div class=\"progress\"><div class=\"progress-bar progress-bar-striped active\" role=\"progressbar\" aria-valuenow=\"" + value.estado + "\" aria-valuemin=\"0\" aria-valuemax=\"100\" style=\"width: " + value.estado + "%\"><span class=\"sr-only\">" + value.estado + "% Complete</span></div></div></td>");
                       $(theTr).append("<td>" + value.responsable + "</td>");
                       $(theTr).append("<td><button class='btn btn-info notificar' value='" + value.responsable_tareaId + "'> Notificar Responsable</button></td>");
                       $(theTr).append("<td><button class='btn btn-success cambiarEstado' value='" + value.id + "'> Cambiar Estado</button></td>");
                       $("#body-principal").append($(theTr));
                    });
                    
                    $(".notificar").click(function (){
                        var idNotificante = this.value;
                        console.log("notificando");
                        $.ajax({
                             url: "/ForosISIS.web/webresources/Responsable/enviarCorreo",
                             type : "GET",
                             contentType: 'application/json',
                             data : { mensaje : 'como vas con tu tarea?', idResponsable : idNotificante },
                         }).done(function(data) {
                             //localStorage.setItem("titulo", data.titulo);
                             alert("Correo enviado!");
                         }, this).error(function(data) {
                             alert("No se ha podido establecer la conexion con el servidor.");
                         }, this);
                    });
                    
                }, this).error(function(data) {
                    alert("No se ha podido establecer la conexion con el servidor.");
                }, this);
                
                //------------------------GET ALL RESPONSABLES
                
//                $.ajax({
//                    url: "/ForosISIS.web/webresources/Responsable/getAllResponsables",
//                    type : "GET",
//                    contentType: 'application/json',
//                }).done(function(data) {
//                    var theSelect = $("#responsableSelect");
//                    $.each(data.records, function(index,value){
//                       var option = $("<option>").attr("value",value.id).text(value.name);
//                       $(theSelect).append($(option));
//                       
//                });
                    
                //-----------------------GET FASES BY FORO
                
//                $.ajax({
//                    url: "/ForosISIS.web/webresources/Fase/getFasesByForo",
//                    type : "GET",
//                    contentType: 'application/json',
//                    data : {idForo : localStorage.getItem("idForo")}
//                }).done(function(data) {
//                    var theSelect = $("#faseSelect");
//                    $.each(data.records, function(index,value){
//                       var option = $("<option>").attr("value",value.id).text(value.name);
//                       $(theSelect).append($(option));
//                       
//                    });
//                });
                
                //faseSelect
                
                //responsableSelect
                
                $("#crear").click(function (){
                   parent.verTareasModal();
                });
                
                $("#btnCrearTarea").click(function(){
                    var losDatos = $("#tareaForm").serializeArray();
                    var idFor = localStorage.getItem("idForo");
                    losDatos.push({idForo : idFor});
                    
                    
                    $.ajax({
                        url: "/ForosISIS.web/webresources/Tarea/crearTarea",
                        type : "GET",
                        contentType: 'application/json',
                        data : { idForo : idForo },
                    }).done(function(data) {
                        //localStorage.setItem("titulo", data.titulo);
                        alert("Se ha creado una nueva tarea");
                        window.top.location = "/ForosISIS.web/index2.html";
                    });
                });
            });
        </script>
    </head>
    <body>
        <div class="container">
            <button style="margin-bottom: 20px;" class="btn btn-info btn-lg btn-block" id="crear"><span class="glyphicon glyphicon-plus-sign"></span> Crear Tarea</button>
            
            <div class="panel panel-primary">
                <div class="panel-heading">
                  <h3 class="panel-title">Tareas del Foro</h3>
                </div>
                <div class="panel-body">
                    <table class="table table-striped" style="margin-bottom: 0;">
                        <thead>
                            <tr>	
                                <th>Nombre</th>
                                <th>Descripcion</th>
                                <th>Estado</th>
                                <th>Responsable</th>
                                <th>Acciones</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="body-principal">	    
                        </tbody>
                    </table>
                </div>
            </div> 
        </div>
        
        
    </body>
</html> 